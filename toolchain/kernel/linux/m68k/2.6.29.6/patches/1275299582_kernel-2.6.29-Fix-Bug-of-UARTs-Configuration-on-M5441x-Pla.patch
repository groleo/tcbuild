From b4d3911bd67622988ab1a8b3eec084febefb7d63 Mon Sep 17 00:00:00 2001
From: Lanttor Guo <lanttor.guo@freescale.com>
Date: Mon, 31 May 2010 17:53:02 +0800
Subject: [PATCH] Fix Bug of UARTs Configuration on M5441x Platform

Update initialization of UARTs.

Signed-off-by: Lanttor Guo <lanttor.guo@freescale.com>
---
 arch/m68k/coldfire/m5441x/devices.c |   93 ++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------
 1 files changed, 54 insertions(+), 39 deletions(-)

diff --git a/arch/m68k/coldfire/m5441x/devices.c b/arch/m68k/coldfire/m5441x/devices.c
index 909b7e2..16e7605 100644
--- a/arch/m68k/coldfire/m5441x/devices.c
+++ b/arch/m68k/coldfire/m5441x/devices.c
@@ -553,68 +553,79 @@ static void m5441x_uarts_init(void)
 #ifdef CONFIG_SERIAL_MCF_UART0
 	/* enable uart0 clock */
 	MCF_PM_PPMCR0 = 24;
-
 	/* gpio pin assignment for uart0 */
-	MCF_GPIO_PAR_UART0 &= (MCF_GPIO_PAR_UART0_U0RXD_MASK |
-				MCF_GPIO_PAR_UART0_U0TXD_MASK);
-	MCF_GPIO_PAR_UART0 |= (MCF_GPIO_PAR_UART0_U0RXD_U0RXD |
-				MCF_GPIO_PAR_UART0_U0TXD_U0TXD);
+	MCF_GPIO_PAR_UART0 =
+		(MCF_GPIO_PAR_UART0 & MCF_GPIO_PAR_UART0_U0RXD_MASK) |
+		MCF_GPIO_PAR_UART0_U0RXD_U0RXD;
+	MCF_GPIO_PAR_UART0 =
+		(MCF_GPIO_PAR_UART0 & MCF_GPIO_PAR_UART0_U0TXD_MASK) |
+		MCF_GPIO_PAR_UART0_U0TXD_U0TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART1
 	/* enable uart1 clock */
 	MCF_PM_PPMCR0 = 25;
 	/* gpio pin assignment for uart1 */
-	MCF_GPIO_PAR_UART1 &= (MCF_GPIO_PAR_UART1_U1RXD_MASK |
-				MCF_GPIO_PAR_UART1_U1TXD_MASK);
-	MCF_GPIO_PAR_UART1 |= (MCF_GPIO_PAR_UART1_U1RXD_U1RXD |
-				MCF_GPIO_PAR_UART1_U1TXD_U1TXD);
+	MCF_GPIO_PAR_UART1 =
+		(MCF_GPIO_PAR_UART1 & MCF_GPIO_PAR_UART1_U1RXD_MASK) |
+		MCF_GPIO_PAR_UART1_U1RXD_U1RXD;
+	MCF_GPIO_PAR_UART1 =
+		(MCF_GPIO_PAR_UART1 & MCF_GPIO_PAR_UART1_U1TXD_MASK) |
+		MCF_GPIO_PAR_UART1_U1TXD_U1TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART2
 	/* enable uart2 clock */
 	MCF_PM_PPMCR0 = 26;
 	/* gpio pin assignment for uart2 */
-	MCF_GPIO_PAR_UART2 &= (MCF_GPIO_PAR_UART2_U2RXD_MASK |
-				MCF_GPIO_PAR_UART2_U2TXD_MASK);
-	MCF_GPIO_PAR_UART2 |= (MCF_GPIO_PAR_UART2_U2RXD_U2RXD |
-				MCF_GPIO_PAR_UART2_U2TXD_U2TXD);
+	MCF_GPIO_PAR_UART2 =
+		(MCF_GPIO_PAR_UART2 & MCF_GPIO_PAR_UART2_U2RXD_MASK) |
+		MCF_GPIO_PAR_UART2_U2RXD_U2RXD;
+	MCF_GPIO_PAR_UART2 =
+		(MCF_GPIO_PAR_UART2 & MCF_GPIO_PAR_UART2_U2TXD_MASK) |
+		MCF_GPIO_PAR_UART2_U2TXD_U2TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART3
 	/* enable uart3 clock */
 	MCF_PM_PPMCR0 = 27;
 	/* gpio pin assignment for uart3 */
-	MCF_GPIO_PAR_DSPI0WH &= (MCF_GPIO_PAR_DSPI0_SIN_MASK |
-				MCF_GPIO_PAR_DSPI0_SOUT_MASK);
-	MCF_GPIO_PAR_DSPI0WH |= (MCF_GPIO_PAR_DSPI0_SIN_U3RXD |
-				MCF_GPIO_PAR_DSPI0_SOUT_U3TXD);
+	MCF_GPIO_PAR_DSPI0WH =
+		(MCF_GPIO_PAR_DSPI0WH & MCF_GPIO_PAR_DSPI0_SIN_MASK) |
+		MCF_GPIO_PAR_DSPI0_SIN_U3RXD;
+	MCF_GPIO_PAR_DSPI0WH =
+		(MCF_GPIO_PAR_DSPI0WH & MCF_GPIO_PAR_DSPI0_SOUT_MASK) |
+		MCF_GPIO_PAR_DSPI0_SOUT_U3TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART4
 	/* enable uart4 clock */
 	MCF_PM_PPMCR1 = 24;
-
 	/* gpio pin assignment for uart4 */
-	MCF_GPIO_PAR_UART0 &= (MCF_GPIO_PAR_UART0_U0RTS_MASK |
-				MCF_GPIO_PAR_UART0_U0CTS_MASK);
-	MCF_GPIO_PAR_UART0 |= (MCF_GPIO_PAR_UART0_U0RTS_U4RXD |
-				MCF_GPIO_PAR_UART0_U0CTS_U4TXD);
+	MCF_GPIO_PAR_UART0 =
+		(MCF_GPIO_PAR_UART0 & MCF_GPIO_PAR_UART0_U0RTS_MASK) |
+		MCF_GPIO_PAR_UART0_U0RTS_U4RXD;
+	MCF_GPIO_PAR_UART0 =
+		(MCF_GPIO_PAR_UART0 & MCF_GPIO_PAR_UART0_U0CTS_MASK) |
+		MCF_GPIO_PAR_UART0_U0CTS_U4TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART5
 	/* enable uart5 clock */
 	MCF_PM_PPMCR1 = 25;
-
 	/* gpio pin assignment for uart5 */
-	MCF_GPIO_PAR_UART1 &= (MCF_GPIO_PAR_UART1_U1RTS_MASK |
-				MCF_GPIO_PAR_UART1_U1CTS_MASK);
-	MCF_GPIO_PAR_UART1 |= (MCF_GPIO_PAR_UART1_U1RTS_U5RXD |
-				MCF_GPIO_PAR_UART1_U1CTS_U5TXD);
+	MCF_GPIO_PAR_UART1 =
+		(MCF_GPIO_PAR_UART1 & MCF_GPIO_PAR_UART1_U1RTS_MASK) |
+		MCF_GPIO_PAR_UART1_U1RTS_U5RXD;
+	MCF_GPIO_PAR_UART1 =
+		(MCF_GPIO_PAR_UART1 & MCF_GPIO_PAR_UART1_U1CTS_MASK) |
+		MCF_GPIO_PAR_UART1_U1CTS_U5TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART6
 	/* enable uart6 clock */
 	MCF_PM_PPMCR1 = 26;
 	/* gpio pin assignment for uart6 */
-	MCF_GPIO_PAR_UART2 &= (MCF_GPIO_PAR_UART2_U2RTS_MASK |
-				MCF_GPIO_PAR_UART2_U2CTS_MASK);
-	MCF_GPIO_PAR_UART2 |= (MCF_GPIO_PAR_UART2_U2RTS_U6RXD |
-				MCF_GPIO_PAR_UART2_U2CTS_U6TXD);
+	MCF_GPIO_PAR_UART2 =
+		(MCF_GPIO_PAR_UART2 & MCF_GPIO_PAR_UART2_U2RTS_MASK) |
+		MCF_GPIO_PAR_UART2_U2RTS_U6RXD;
+	MCF_GPIO_PAR_UART2 =
+		(MCF_GPIO_PAR_UART2 & MCF_GPIO_PAR_UART2_U2CTS_MASK) |
+		MCF_GPIO_PAR_UART2_U2CTS_U6TXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART7
 	/* enable uart7 clock */
@@ -629,19 +640,23 @@ static void m5441x_uarts_init(void)
 	/* enable uart8 clock */
 	MCF_PM_PPMCR1 = 28;
 	/* gpio pin assignment for uart8 */
-	MCF_GPIO_PAR_CANI2C &= (MCF_GPIO_PAR_CANI2C_I2C0SCL_MASK |
-				MCF_GPIO_PAR_CANI2C_I2C0SDA_MASK);
-	MCF_GPIO_PAR_CANI2C |= (MCF_GPIO_PAR_CANI2C_I2C0SCL_U8TXD |
-				MCF_GPIO_PAR_CANI2C_I2C0SDA_U8RXD);
+	MCF_GPIO_PAR_CANI2C =
+		(MCF_GPIO_PAR_CANI2C & MCF_GPIO_PAR_CANI2C_I2C0SCL_MASK) |
+		MCF_GPIO_PAR_CANI2C_I2C0SCL_U8TXD;
+	MCF_GPIO_PAR_CANI2C =
+		(MCF_GPIO_PAR_CANI2C & MCF_GPIO_PAR_CANI2C_I2C0SDA_MASK) |
+		MCF_GPIO_PAR_CANI2C_I2C0SDA_U8RXD;
 #endif
 #ifdef CONFIG_SERIAL_MCF_UART9
 	/* enable uart4 clock */
 	MCF_PM_PPMCR1 = 29;
 	/* gpio pin assignment for uart9 */
-	MCF_GPIO_PAR_CANI2C &= (MCF_GPIO_PAR_CANI2C_CAN1TX_MASK |
-				MCF_GPIO_PAR_CANI2C_CAN1RX_MASK);
-	MCF_GPIO_PAR_CANI2C |= (MCF_GPIO_PAR_CANI2C_CAN1TX_U9TXD |
-				MCF_GPIO_PAR_CANI2C_CAN1RX_U9RXD);
+	MCF_GPIO_PAR_CANI2C =
+		(MCF_GPIO_PAR_CANI2C & MCF_GPIO_PAR_CANI2C_CAN1TX_MASK) |
+		MCF_GPIO_PAR_CANI2C_CAN1TX_U9TXD;
+	MCF_GPIO_PAR_CANI2C =
+		(MCF_GPIO_PAR_CANI2C & MCF_GPIO_PAR_CANI2C_CAN1RX_MASK) |
+		MCF_GPIO_PAR_CANI2C_CAN1RX_U9RXD;
 #endif
 }
 #endif
-- 
1.6.4

